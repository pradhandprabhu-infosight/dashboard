
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://qmmcifiwmnqnnjndyxdj.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtbWNpZml3bW5xbm5qbmR5eGRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NjE2ODYsImV4cCI6MjA2NDQzNzY4Nn0.awYNH_00ZBMZQWPIOasXxiTOZragLYUazwbSnOOC6xA'
    );

    const USERNAME = "{{ username }}";

    // ---------- Charts ----------
    async function renderStudentLineChart(days = 7) {
      const now = new Date();
      const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
      const startOfWindow = new Date(endOfToday);
      startOfWindow.setDate(startOfWindow.getDate() - (days - 1));
      const ymdLocal = (d) => d.toLocaleDateString('en-CA');

      const { data: convos } = await supabase
        .from('conversation')
        .select('created_at')
        .eq('user_name', USERNAME)
        .gte('created_at', startOfWindow.toISOString())
        .lte('created_at', endOfToday.toISOString());

      const usageByDate = new Map();
      for (let i = 0; i < days; i++) {
        const d = new Date(startOfWindow);
        d.setDate(startOfWindow.getDate() + i);
        usageByDate.set(ymdLocal(d), 0);
      }

      for (const c of convos || []) {
        const localDay = ymdLocal(new Date(c.created_at));
        if (usageByDate.has(localDay)) {
          usageByDate.set(localDay, usageByDate.get(localDay) + 1);
        }
      }

      const labels = Array.from(usageByDate.keys());
      const data = Array.from(usageByDate.values());

      new Chart(document.getElementById('usageChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Questions Asked',
            data,
            borderColor: 'green',
            backgroundColor: 'lightgreen',
            fill: true,
            tension: 0.3,
            pointRadius: 3
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Questions' }, beginAtZero: true, precision: 0 }
          }
        }
      });
    }

    // ---------- KPIs ----------
function renderCoverageList(raw) {
  const ul = document.getElementById('coverage');
  ul.innerHTML = '';

  if (!raw || !raw.trim()) return;

  const tokens = raw.trim().split(/\s+/);
  tokens.forEach(tok => {
    const li = document.createElement('li');
    li.textContent = tok;
    ul.appendChild(li);
  });
}

    
function setProgress(valOutOf100) {
  const val = Math.max(0, Math.min(valOutOf100 ?? 0, 100));
  const pct = Math.round((val / 100) * 100);
  const bar = document.getElementById('scoreBar');
  bar.style.width = pct + '%';
  bar.textContent = pct + '%';
}

    async function renderStudentKPIs() {
      const { data: user } = await supabase
        .from('USER')
        .select('*')
        .eq('user_name', USERNAME)
        .single();

      if (!user) return;

      document.getElementById('topic').textContent = user.current_topic || 'N/A';
      document.getElementById('difficulty').textContent = user.challenge_mode || 'N/A';
      document.getElementById('assessment').textContent = user.knowledge_assessment || 'N/A';

      setProgress(user.score);
      renderCoverageList(user.coverage_status || '');
    }

    renderStudentKPIs();
    renderStudentLineChart();
  </script>
  <style>
    :root {
      --card-bg: #ffffff;
      --muted-bg: #f7f7f7;
      --border: #e5e5e5;
      --shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
      background: #f4f4f4;
      padding: 2rem;
      color: #111;
    }

    .container {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      max-width: 980px;
      margin: auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    h1 {
      text-align: center;
      margin: 0 0 1.25rem 0;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    /* --- Layout --- */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    /* First row: one stacked card for topic/score/difficulty */
    .stack-card {
      background: var(--muted-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.25rem;
    }
    .stack-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      align-items: center;
      gap: 0.75rem;
      padding: 0.35rem 0;
      border-bottom: 1px dashed var(--border);
    }
    .stack-row:last-child { border-bottom: 0; }

    .label {
      font-weight: 700;
    }

    /* Assessment & Coverage side-by-side on wide screens */
    .two-col {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    @media (min-width: 880px) {
      .two-col {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: var(--muted-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      min-height: 160px;
    }

    /* Progress bar */
    .progress-bar {
      background-color: #e6e6e6;
      border-radius: 999px;
      overflow: hidden;
      height: 20px;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: #4caf50;
      color: #fff;
      text-align: center;
      line-height: 20px;
      font-size: 12px;
      transition: width 400ms ease;
    }

    ul { margin: 0.25rem 0 0 1rem; }
    li { margin: 0.25rem 0; }

    canvas {
      width: 100% !important;
      max-height: 380px;
      margin-top: 1rem;
    }
    
    .backlink { display:inline-block; margin-bottom: 1rem; color:#2563eb; }
  </style>
</head>
<body>
  <a class="backlink" href="/">‚Üê Back to Admin</a>
  <div class="container">
    <h1>{{ username }}</h1>

    <div class="grid">

      <!-- Stacked KPI card -->
      <div class="stack-card">
        <div class="stack-row">
          <div class="label">Current Topic:</div>
          <div id="topic">Loading...</div>
        </div>
        <div class="stack-row">
          <div class="label">Topic Progress</Progress>:</div>
          <div>
            <div class="progress-bar" style="margin-top: 0.5rem;">
              <div id="scoreBar" class="progress-fill">0%</div>
            </div>
          </div>
        </div>
        <div class="stack-row">
          <div class="label">Current Difficulty:</div>
          <div id="difficulty">Loading...</div>
        </div>
      </div>

      <!-- Assessment & Coverage -->
      <div class="two-col">
        <div class="card">
          <div class="label">Knowledge Assessment:</div>
          <div id="assessment" style="margin-top: 0.5rem;">Loading...</div>
        </div>

        <div class="card">
          <div class="label">Coverage Status:</div>
          <ul id="coverage"><li>Loading...</li></ul>
        </div>
      </div>

      <canvas id="usageChart"></canvas>
    </div>
  </div>
</body>
</html>
